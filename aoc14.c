
#define _CRT_SECURE_NO_WARNINGS
#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <stdbool.h>
#undef max
typedef uint8_t  U1;
typedef uint32_t U4;
typedef int32_t  S4;
typedef uint64_t U8;
#define countof(a) (sizeof(a)/sizeof(*(a)))


#if 1
char const *in[] = {
    /* "499,1 -> 501,1" */
    "498,4 -> 498,6 -> 496,6",
    "503,4 -> 502,4 -> 502,9 -> 494,9",
};

#else
char const *in[] = {
    "522,57 -> 522,59 -> 516,59 -> 516,67 -> 531,67 -> 531,59 -> 526,59 -> 526,57",
    "479,105 -> 479,107 -> 472,107 -> 472,113 -> 483,113 -> 483,107 -> 482,107 -> 482,105",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "510,43 -> 515,43",
    "477,141 -> 477,144 -> 469,144 -> 469,148 -> 491,148 -> 491,144 -> 483,144 -> 483,141",
    "525,54 -> 537,54 -> 537,53",
    "504,47 -> 509,47",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "489,136 -> 494,136",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "479,105 -> 479,107 -> 472,107 -> 472,113 -> 483,113 -> 483,107 -> 482,107 -> 482,105",
    "460,93 -> 464,93",
    "499,32 -> 499,35 -> 498,35 -> 498,40 -> 512,40 -> 512,35 -> 505,35 -> 505,32",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "477,141 -> 477,144 -> 469,144 -> 469,148 -> 491,148 -> 491,144 -> 483,144 -> 483,141",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "469,91 -> 473,91",
    "496,15 -> 496,16 -> 510,16",
    "500,138 -> 505,138",
    "499,32 -> 499,35 -> 498,35 -> 498,40 -> 512,40 -> 512,35 -> 505,35 -> 505,32",
    "479,105 -> 479,107 -> 472,107 -> 472,113 -> 483,113 -> 483,107 -> 482,107 -> 482,105",
    "469,87 -> 473,87",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "522,49 -> 527,49",
    "463,91 -> 467,91",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "496,136 -> 501,136",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "472,93 -> 476,93",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "499,32 -> 499,35 -> 498,35 -> 498,40 -> 512,40 -> 512,35 -> 505,35 -> 505,32",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "477,141 -> 477,144 -> 469,144 -> 469,148 -> 491,148 -> 491,144 -> 483,144 -> 483,141",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "486,138 -> 491,138",
    "499,32 -> 499,35 -> 498,35 -> 498,40 -> 512,40 -> 512,35 -> 505,35 -> 505,32",
    "481,130 -> 481,131 -> 494,131",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "514,45 -> 519,45",
    "518,47 -> 523,47",
    "501,49 -> 506,49",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "484,100 -> 488,100",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "481,102 -> 485,102",
    "475,91 -> 479,91",
    "499,32 -> 499,35 -> 498,35 -> 498,40 -> 512,40 -> 512,35 -> 505,35 -> 505,32",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "522,57 -> 522,59 -> 516,59 -> 516,67 -> 531,67 -> 531,59 -> 526,59 -> 526,57",
    "478,93 -> 482,93",
    "492,134 -> 497,134",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "477,141 -> 477,144 -> 469,144 -> 469,148 -> 491,148 -> 491,144 -> 483,144 -> 483,141",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "472,89 -> 476,89",
    "479,105 -> 479,107 -> 472,107 -> 472,113 -> 483,113 -> 483,107 -> 482,107 -> 482,105",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "507,45 -> 512,45",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "522,57 -> 522,59 -> 516,59 -> 516,67 -> 531,67 -> 531,59 -> 526,59 -> 526,57",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "472,84 -> 482,84",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "479,105 -> 479,107 -> 472,107 -> 472,113 -> 483,113 -> 483,107 -> 482,107 -> 482,105",
    "477,141 -> 477,144 -> 469,144 -> 469,148 -> 491,148 -> 491,144 -> 483,144 -> 483,141",
    "479,105 -> 479,107 -> 472,107 -> 472,113 -> 483,113 -> 483,107 -> 482,107 -> 482,105",
    "479,105 -> 479,107 -> 472,107 -> 472,113 -> 483,113 -> 483,107 -> 482,107 -> 482,105",
    "508,49 -> 513,49",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "466,93 -> 470,93",
    "522,57 -> 522,59 -> 516,59 -> 516,67 -> 531,67 -> 531,59 -> 526,59 -> 526,57",
    "499,32 -> 499,35 -> 498,35 -> 498,40 -> 512,40 -> 512,35 -> 505,35 -> 505,32",
    "522,57 -> 522,59 -> 516,59 -> 516,67 -> 531,67 -> 531,59 -> 526,59 -> 526,57",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "511,47 -> 516,47",
    "493,138 -> 498,138",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "522,57 -> 522,59 -> 516,59 -> 516,67 -> 531,67 -> 531,59 -> 526,59 -> 526,57",
    "499,102 -> 503,102",
    "477,141 -> 477,144 -> 469,144 -> 469,148 -> 491,148 -> 491,144 -> 483,144 -> 483,141",
    "525,54 -> 537,54 -> 537,53",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "496,15 -> 496,16 -> 510,16",
    "487,98 -> 491,98",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "477,141 -> 477,144 -> 469,144 -> 469,148 -> 491,148 -> 491,144 -> 483,144 -> 483,141",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "490,96 -> 494,96",
    "496,100 -> 500,100",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "493,98 -> 497,98",
    "466,89 -> 470,89",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "481,130 -> 481,131 -> 494,131",
    "481,126 -> 481,121 -> 481,126 -> 483,126 -> 483,122 -> 483,126 -> 485,126 -> 485,125 -> 485,126",
    "499,32 -> 499,35 -> 498,35 -> 498,40 -> 512,40 -> 512,35 -> 505,35 -> 505,32",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "487,102 -> 491,102",
    "465,161 -> 465,155 -> 465,161 -> 467,161 -> 467,151 -> 467,161 -> 469,161 -> 469,151 -> 469,161",
    "522,57 -> 522,59 -> 516,59 -> 516,67 -> 531,67 -> 531,59 -> 526,59 -> 526,57",
    "493,102 -> 497,102",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "479,80 -> 479,78 -> 479,80 -> 481,80 -> 481,77 -> 481,80 -> 483,80 -> 483,77 -> 483,80 -> 485,80 -> 485,71 -> 485,80 -> 487,80 -> 487,74 -> 487,80 -> 489,80 -> 489,71 -> 489,80 -> 491,80 -> 491,75 -> 491,80",
    "487,29 -> 487,21 -> 487,29 -> 489,29 -> 489,22 -> 489,29 -> 491,29 -> 491,22 -> 491,29 -> 493,29 -> 493,19 -> 493,29 -> 495,29 -> 495,23 -> 495,29 -> 497,29 -> 497,27 -> 497,29 -> 499,29 -> 499,23 -> 499,29 -> 501,29 -> 501,26 -> 501,29",
    "515,49 -> 520,49",
    "490,100 -> 494,100",
};
#endif

#ifdef assert
#undef assert
#endif
#define assert(x, ...) ((x) ? 1 : \
                   (fprintf(stderr, "break at line %d, %s, failed:\n    "#x"\n", __LINE__, __func__), \
                    fprintf(stderr, "" __VA_ARGS__),\
                    fflush(stderr), __debugbreak(), 0))


typedef struct Pt { U4 x, y; struct Pt *next; } Pt;

/// returns true if it is a number
bool
parse_num(char const *at, U4 *val_out, char const **at_out)
{
    bool is_num = false;
    U4   val    = 0;

    for (; '0' <= *at && *at <= '9'; ++at)
    {
        is_num = true;
        val *= 10;
        val += *at - '0';
    }

    if (val_out) { *val_out = val; }
    if (at_out)  { *at_out  = at;  }
    return is_num;
}

bool streq(char const *a, char const *b) { return a && b && strcmp(a,b) == 0; }
bool streqn(char const *a, char const *b, U4 n) { return a && b && strncmp(a,b,n) == 0; }


typedef struct Map {
    Pt    min_pt;
    Pt    max_pt;
    Pt    dims;
    Pt    src_pt;
    char *buf;
} Map;

char *map_pt(Map *map, Pt pt)
{
    assert(pt.x >= map->min_pt.x);
    assert(pt.y >= map->min_pt.y);
    assert(pt.x <= map->max_pt.x);
    assert(pt.y <= map->max_pt.y);


    Pt draw_pt = { pt.x - map->min_pt.x, pt.y - map->min_pt.y };
    return &map->buf[draw_pt.y * map->dims.x + draw_pt.x];
}

void
init_lines(Pt **lines, U4 *lines_n, U4 in_n)
{
    for (U4 in_i = 0; in_i < in_n; ++in_i)
    {
        Pt *pt_p = NULL;
        for (char const *at = in[in_i]; *at;)
        {
            Pt *pt = malloc(sizeof(*pt));
            *pt = (Pt){0};

            bool is_num = parse_num(at, &pt->x, &at);
            assert(is_num);

            assert(*at == ',');
            ++at;

            is_num = parse_num(at, &pt->y, &at);
            assert(is_num);

            { // add point to line
                if (pt_p)
                {   pt_p->next = pt;   }
                else
                {   lines[lines_n[0]++] = pt;   }
                pt_p = pt;
            }

            if (streqn(at, " -> ", 4)) // do we have another pt in the line?
            {   at += 4;   }
            else
            {   assert(*at == '\0', "at == \"%s\"\n", at); break;   }
        }
    }
}

void
draw_map(Map *map)
{
    for (U4 y = map->min_pt.y; y <= map->max_pt.y; ++y)
    {
        printf("%3u: ", y);
        for (U4 x = map->min_pt.x; x <= map->max_pt.x; ++x)
        {
            char *pt = map_pt(map, (Pt){x,y});
            printf("%c", *pt); fflush(stdout);
        }
        printf("\n"); fflush(stdout);
    }
    printf("\n"); fflush(stdout);
}

bool pt_eq(Pt a, Pt b) { return a.x == b.x && a.y == b.y; }

Map
init_map(Pt **lines, U4 lines_n)
{
    Map map = { .min_pt = { ~(U4)0, 0 }, .src_pt = {500,0} };
    // init map
    for (U4 line_i = 0; line_i < lines_n; ++line_i)
    {
        for (Pt *pt = lines[line_i]; pt; pt = pt->next)
        {
            if (pt->x < map.min_pt.x) { map.min_pt.x = pt->x; }
            /* if (pt->y < map->min_pt.y) { map->min_pt.y = pt->y; } */
            if (pt->x > map.max_pt.x) { map.max_pt.x = pt->x; }
            if (pt->y > map.max_pt.y) { map.max_pt.y = pt->y; }
        }
    }

    return map;
}


void draw_rock(Map *map, Pt **lines, U4 lines_n)
{
    map->dims = (Pt){ map->max_pt.x - map->min_pt.x + 1, map->max_pt.y - map->min_pt.y + 1 };

    U4 size = map->dims.x * map->dims.y;
    map->buf = malloc(size);
    memset(map->buf, '.', size); // set to air as default

    *map_pt(map, map->src_pt) = '+';  // draw src
    for (U4 line_i = 0; line_i < lines_n; ++line_i)
    { // draw rock lines
        for (Pt *pt = lines[line_i]; pt; pt = pt->next)
        {
            Pt *to = pt->next;
            if (to)
            {
                // sign of difference
                int x_d = (pt->x < to->x) - (pt->x > to->x);
                int y_d = (pt->y < to->y) - (pt->y > to->y);

                // draw lines in 1 dimension (only 1 changes at a time)
                if (x_d) for (Pt it = *pt; it.x != to->x; it.x += x_d)
                {   *map_pt(map, it) = '#';   }
                else if (y_d) for (Pt it = *pt; it.y != to->y; it.y += y_d)
                {   *map_pt(map, it) = '#';   }
                *map_pt(map, *to) = '#';
            }
        }
    }
    /* draw_map(map); */
}

U4
simulate_sand(Map *map)
{
    U4 sand_i = 1;
    for (;; ++sand_i)
    {
        Pt sand_pt = map->src_pt;
        Pt move_pt = sand_pt;
        bool out_of_bounds = false;

        for (;;) // stop once we can't move any more
        {
            // down
            if (++move_pt.y > map->max_pt.y)
            {   out_of_bounds = true; break;   }
            if (*map_pt(map, move_pt) == '.') // air
            {   sand_pt = move_pt; continue;   }


            // down-left
            if (--move_pt.x < map->min_pt.x)
            {   out_of_bounds = true; break;   }
            if (*map_pt(map, move_pt) == '.') // air
            {   sand_pt = move_pt; continue;   }


            // down-right
            move_pt.x += 2;
            if (move_pt.x > map->max_pt.x)
            {   out_of_bounds = true; break;   }
            if (*map_pt(map, move_pt) == '.') // air
            {   sand_pt = move_pt; continue;   }

            break;
        }

        if (pt_eq(sand_pt, map->src_pt))
        {   ++sand_i; break;   }
        if (out_of_bounds)
        {
            assert(0);
            break;
        }

        *map_pt(map, sand_pt) = 'o';
        /* if (sand_i == 1 || */
        /*     sand_i == 2 || */
        /*     sand_i == 5 || */
        /*     sand_i == 22 || */
        /*     sand_i == 24) */
        /* { */
        /*     printf("%u:\n", sand_i); */
        /*     draw_map(map); */
        /* } */
    }
    draw_map(map);
    return sand_i - 1;
}

U4 aoc14()
{
    printf("\n\n------------\n\n");

    Pt *lines[countof(in)] = {0};
    U4 lines_n = 0;

    init_lines(lines, &lines_n, countof(lines));

    Map map[1] = { init_map(lines, lines_n) };
    draw_rock(map, lines, lines_n);

    U4 result = simulate_sand(map);

    return result;
}

U4 aoc14b()
{
    printf("\n\n------------\n\n");

    Pt *lines[countof(in)+1] = {0};
    U4 lines_n = 0;

    init_lines(lines, &lines_n, countof(in));

    Map map[1] = { init_map(lines, lines_n) };
    map->min_pt.x = 0;
    map->max_pt.x = 1000;
    map->max_pt.y += 2;

    Pt floor[2] = {
        {map->min_pt.x, map->max_pt.y, &floor[1]},
        {map->max_pt.x, map->max_pt.y} };
    lines[lines_n++] = floor;

    draw_rock(map, lines, lines_n);

    U4 result = simulate_sand(map);

    return result;
}

int main()
{
    U4 result =aoc14b();
    printf("result = %u\n", result);
}
